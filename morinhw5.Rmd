---
title: "HW#5"
author: "Blain Morin"
date: "November 23, 2018"
output: pdf_document
---


```{r, echo = FALSE}

### Load Libraries

library(knitr)
library(readr)
library(MASS)
library(leaps)
library(dplyr)
library(stargazer)
library(caret)

```

# Question 1:

```{r, echo = FALSE, message = FALSE, warning = FALSE}

### Load data
iod = read_csv("iodatadev.csv")

### Filter out columns with more that 10% missing data
iod.clean = Filter(function(x) mean(is.na(x)) < 0.1, iod)

### Get complete cases
iod.clean = iod.clean %>%
  filter(complete.cases(.))

### Filter out ids
iod.clean = iod.clean %>%
  select(-X1, -ID, -"..2", -"..2_1", -WEIGHT, -HEIGHT, -c.cys, -drds, -mayodonor, -rass1, -CSG, -gronigendonor, - ccpdonor, - c.scr, - mayo)

```



```{r, echo = FALSE, message = FALSE, warning = FALSE, cache = TRUE}

# ### Forward steps
# forward = regsubsets(GFR~., data = iod.clean, nvmax=26, method="forward")
# forward.summary = summary(forward)
# forward.summary$rsq
# forward.summary$

set.seed(1)

### Forward and backward step regression
full = lm(GFR ~ ., iod.clean)
base = lm(GFR ~ 1, iod.clean)
fulltest = stepAIC(full, scope = list(upper=full,lower=base), direction = "both", trace = FALSE)
summary.fulltest = summary(fulltest)
rsquared.fulltest = summary.fulltest$r.squared


### Bootstrap 1000 samples and get rsquares
set.seed(1)
nsims = 1000

r2boot.train = rep(NA, nsims)
r2boot.test = rep(NA, nsims)

for (i in 1:nsims) {
  
  train = sample_n(iod.clean, size = nrow(iod.clean), replace = TRUE)
  test = anti_join(iod.clean, train)
  mod = stepAIC(lm(GFR ~ ., data = train), direction = "both", trace = FALSE)
  summary.mod = summary(mod)
  r2boot.train[i] = summary.mod$r.squared
  preds = predict(mod, test)
  tss = sum((test$GFR - mean(test$GFR))^2)
  ess = sum((test$GFR - preds)^2)
  r2boot.test[i] = 1 - (ess/tss)
  
  
}


### Calculate average optimism
optimism = r2boot.train - r2boot.test
ave.optimism = mean(optimism)

### Calculate Estimated Test r2
est.test.r2 = rsquared.fulltest - ave.optimism 



```


# Question 2:


## Step CV:

```{r, echo = FALSE, warning = TRUE, message = FALSE}

predict.regsubsets=function(object,newdata,id,...){
  form=as.formula(object$call[[2]])
  mat=model.matrix(form,newdata)
  coefi=coef(object,id=id)
  xvars=names(coefi)
  mat[,xvars]%*%coefi
}

### Crossvalidate number of variables for step

set.seed(11)

folds = 10

test = createFolds(iod.clean$GFR, k = folds)

cv.errors = matrix(NA, nrow = folds, ncol = ncol(iod.clean) - 1 )

for (i in 1:folds) {
  
  training = iod.clean[-test[[i]], ]
  testing = iod.clean[test[[i]], ]
  best.model = regsubsets(GFR ~ .,
                          data = training,
                          nvmax = ncol(iod.clean) )
  
  for (j in 1:(ncol(iod.clean)-1)) {
    
    preds = predict.regsubsets(best.model, newdata = testing, id = j)
    MSE = mean((testing$GFR - preds)^2)
    cv.errors[i, j] = MSE
    
    
    
  }
  
  
}


mean.cv.errors = apply(cv.errors, 2, mean)
which.min(mean.cv.errors)
plot(mean.cv.errors,type='b')

```

## Ridge 


```{r}




```